name: Build All Platforms

on:
  push:
    branches: [ "release" ]
    tags: [ "v*" ]
  workflow_dispatch:

jobs:
  # 1. Web Build & Deploy
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Build Web
        run: |
          # Extract repository name for base-href (e.g., /health_food_search/)
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          flutter config --enable-web
          flutter pub get
          flutter build web --release --base-href "/$REPO_NAME/"
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web

  # 2. Android Build
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: Build APK
        run: |
          flutter pub get
          flutter build apk --release
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-app-release
          path: build/app/outputs/flutter-apk/app-release.apk

  # 3. Windows Build
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Build Windows
        run: |
          flutter config --enable-windows-desktop
          flutter pub get
          flutter build windows --release
      - name: Compress Windows Build
        run: |
          powershell Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath windows-app.zip
      - name: Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: windows-app-release
          path: windows-app.zip

  # 4. macOS Build (Unsigned / Ad-hoc)
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Build macOS
        run: |
          flutter config --enable-macos-desktop
          flutter pub get
          flutter build macos --release
      - name: Compress App
        run: cd build/macos/Build/Products/Release && zip -r macos-app.zip health_food_search.app
      - name: Upload macOS Build
        uses: actions/upload-artifact@v4
        with:
          name: macos-app-release
          path: build/macos/Build/Products/Release/macos-app.zip

  # 5. iOS Build (Unsigned / Simulator mainly)
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Build iOS (No Codesign)
        run: |
          flutter pub get
          flutter build ios --release --no-codesign
      - name: Compress Payload
        run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload/
          zip -r ios-app-unsigned.ipa Payload
      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-unsigned
          path: ios-app-unsigned.ipa

  # 6. Create GitHub Release
  create-release:
    needs: [build-android, build-windows, build-macos, build-ios]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/release'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Get Version
        id: get_version
        run: |
          VERSION=$(grep '^version: ' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Extract Release Notes
        id: extract_release_notes
        run: |
          awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md > RELEASE_NOTES.txt
          cat RELEASE_NOTES.txt

      - name: Download Android Artifact
        uses: actions/download-artifact@v4
        with:
          name: android-app-release
      
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-app-release
      
      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-app-release
      
      - name: Download iOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-app-unsigned
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          body_path: RELEASE_NOTES.txt
          files: |
            app-release.apk
            windows-app.zip
            macos-app.zip
            ios-app-unsigned.ipa
          draft: false
          prerelease: false
